<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <title>任务管理PWA</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
      user-select: none;
      touch-action: none;
      overflow: hidden;
      background-color: #f9f9f9;
    }
    #tasks {
      position: relative;
      width: 100%;
      height: 90vh;
      border: 1px dashed #ddd;
    }
    .task {
      position: absolute;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 12px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      word-wrap: break-word;
      max-width: 150px;
      cursor: move;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    .delete-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ff4d4f;
      color: white;
      border: none;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      line-height: 14px;
      cursor: pointer;
      font-size: 12px;
      z-index: 1;
    }
    input, button {
      font-size: 12px;
      padding: 6px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h3>任务管理PWA</h3>
  <input type="text" id="task-input" placeholder="新任务内容">
  <button id="add-btn">添加任务</button>
  <div id="tasks"></div>

  <script>
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    const container = document.getElementById('tasks');

    function saveTasks(){
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    function renderTasks(){
      container.innerHTML = '';
      tasks.forEach((task, index)=>{
        const el = document.createElement('div');
        el.className = 'task';
        el.innerText = task.text;
        el.style.left = task.x + 'px';
        el.style.top = task.y + 'px';

        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.innerText = '×';
        delBtn.onclick = (e)=>{
          e.stopPropagation();
          tasks.splice(index,1);
          saveTasks();
          renderTasks();
        };
        el.appendChild(delBtn);

        let offsetX, offsetY, dragging = false;
        el.addEventListener('pointerdown', (e)=>{
          dragging = true;
          offsetX = e.clientX - el.offsetLeft;
          offsetY = e.clientY - el.offsetTop;
          el.setPointerCapture(e.pointerId);
        });
        el.addEventListener('pointermove', (e)=>{
          if(dragging){
            e.preventDefault();
            let x = e.clientX - offsetX;
            let y = e.clientY - offsetY;

            const maxX = container.clientWidth - el.offsetWidth;
            const maxY = container.clientHeight - el.offsetHeight;
            x = Math.min(maxX, Math.max(0, x));
            y = Math.min(maxY, Math.max(0, y));

            el.style.left = x + 'px';
            el.style.top = y + 'px';
          }
        });
        el.addEventListener('pointerup', (e)=>{
          if(dragging){
            dragging = false;
            task.x = el.offsetLeft;
            task.y = el.offsetTop;
            saveTasks();
          }
        });
        el.addEventListener('pointercancel', ()=>{
          dragging = false;
        });

        container.appendChild(el);
      });
    }

    document.getElementById('add-btn').onclick = ()=>{
      const input = document.getElementById('task-input');
      const text = input.value.trim();
      if(text){
        tasks.push({text, x: 10, y: 10});
        input.value='';
        saveTasks();
        renderTasks();
      }
    };

    renderTasks();

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
