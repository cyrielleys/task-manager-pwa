<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>任务管理 PWA 示例</title>
  <style>
    /* 基础样式和布局 */
    body {
      margin: 0;
      font-family: sans-serif;
      background: #fafafa;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #f8f8f8;
      border-bottom: 1px solid #ccc;
    }
    .controls input {
      flex: 1 1 auto;
      min-width: 120px;
      padding: 6px;
      font-size: 16px;
    }
    .controls button {
      padding: 6px 12px;
      font-size: 16px;
    }

    /* 画布区域样式 */
    #canvas {
      position: relative;
      width: 100%;
      height: calc(100vh - 50px); /* 让画布填满剩余空间，高度可根据需要调整 */
      overflow: auto;
      /* 棋盘格背景：淡灰色交替方格 */
      background-color: #f0f0f0;
      background-image: 
        linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc),
        linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;  /* 第二层偏移10px，形成棋盘格:contentReference[oaicite:21]{index=21} */
    }

    /* 任务卡片样式 */
    .task {
      position: absolute;
      min-width: 150px;
      max-width: 300px;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: #fff;
      padding: 8px;
      box-shadow: 1px 1px 6px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }
    .task.selected {
      border-color: #f00;  /* （可选）选中任务时高亮边框 */
    }
    .task-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .task-note {
      font-size: 14px;
      line-height: 1.4;
      display: none; /* 默认备注隐藏，按需展开 */
    }
    .task.expanded .task-note {
      display: block;
    }
  </style>
</head>
<body>

  <!-- 控制栏：包含输入字段和按钮 -->
  <div class="controls">
    <input id="titleInput" type="text" placeholder="新任务内容" />
    <input id="noteInput" type="text" placeholder="新备注内容（可选）" />
    <button id="addBtn">添加任务</button>
    <!-- 导出和导入按钮 -->
    <button id="exportBtn">导出</button>
    <button id="importBtn">导入</button>
  </div>

  <!-- 画布区域，包含任务元素 -->
  <div id="canvas"></div>

  <script>
    // 任务数据列表
    let tasks = [];

    // 从 localStorage 恢复已有任务（如果有）
    const saved = localStorage.getItem('tasksData');
    if (saved) {
      try {
        tasks = JSON.parse(saved);
      } catch (e) {
        console.warn('本地存储的任务数据解析失败，将忽略。');
        tasks = [];
      }
    }

    // 渲染任务列表到界面
    const canvas = document.getElementById('canvas');
    function renderAllTasks() {
      canvas.innerHTML = '';  // 清空画布
      tasks.forEach(task => {
        const taskEl = document.createElement('div');
        taskEl.className = 'task' + (task.expanded ? ' expanded' : '');
        taskEl.style.left = task.x + 'px';
        taskEl.style.top = task.y + 'px';
        // 设置内容
        const titleEl = document.createElement('div');
        titleEl.className = 'task-title';
        titleEl.textContent = task.title;
        const noteEl = document.createElement('div');
        noteEl.className = 'task-note';
        noteEl.textContent = task.note;
        taskEl.appendChild(titleEl);
        taskEl.appendChild(noteEl);
        // 点击任务切换展开/折叠备注
        taskEl.addEventListener('click', () => {
          task.expanded = !task.expanded;
          taskEl.classList.toggle('expanded', task.expanded);
          // 更新存储中的展开状态
          saveTasks();
        });
        canvas.appendChild(taskEl);
      });
    }

    // 保存任务列表到 localStorage
    function saveTasks() {
      localStorage.setItem('tasksData', JSON.stringify(tasks));
    }

    // 初始化渲染已有任务
    renderAllTasks();

    // “添加任务”按钮逻辑
    document.getElementById('addBtn').addEventListener('click', () => {
      const titleInput = document.getElementById('titleInput');
      const noteInput = document.getElementById('noteInput');
      const title = titleInput.value.trim();
      const note = noteInput.value.trim();
      if (title === '') {
        alert('任务标题不能为空！');
        return;
      }
      // 设置默认位置 (例如在左上角依次向下排列)
      const x = 10;
      const y = tasks.length * 60 + 10;  // 简单计算垂直位置错开
      const newTask = { title, note, x, y, expanded: false };
      tasks.push(newTask);
      saveTasks();
      // 渲染新任务元素
      const taskEl = document.createElement('div');
      taskEl.className = 'task';
      taskEl.style.left = x + 'px';
      taskEl.style.top = y + 'px';
      const titleEl = document.createElement('div');
      titleEl.className = 'task-title';
      titleEl.textContent = title;
      const noteEl = document.createElement('div');
      noteEl.className = 'task-note';
      noteEl.textContent = note;
      taskEl.appendChild(titleEl);
      taskEl.appendChild(noteEl);
      taskEl.addEventListener('click', () => {
        newTask.expanded = !newTask.expanded;
        taskEl.classList.toggle('expanded', newTask.expanded);
        saveTasks();
      });
      canvas.appendChild(taskEl);
      // 清空输入框
      titleInput.value = '';
      noteInput.value = '';
    });

    // “导出”按钮逻辑：将任务列表导出为 JSON 并复制到剪贴板
    document.getElementById('exportBtn').addEventListener('click', async () => {
      if (tasks.length === 0) {
        alert('当前没有任何任务可导出！');
        return;
      }
      const jsonStr = JSON.stringify(tasks, null, 2);  // 格式化缩进，便于阅读
      try {
        // 优先使用异步 Clipboard API 写入剪贴板:contentReference[oaicite:22]{index=22}
        await navigator.clipboard.writeText(jsonStr);
        alert('任务列表已导出并复制到剪贴板！');
      } catch (err) {
        console.warn('Clipboard API 写入失败，尝试使用execCommand:', err);
        // 如果 Clipboard API 不支持或被拒绝，使用传统方法复制
        try {
          const textarea = document.createElement('textarea');
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          textarea.value = jsonStr;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');  // 同步复制选中文本:contentReference[oaicite:23]{index=23}
          document.body.removeChild(textarea);
          alert('任务列表已导出并复制到剪贴板！');
        } catch (err2) {
          alert('自动复制失败，请手动复制 JSON 数据。\n' + jsonStr);
        }
      }
    });

    // “导入”按钮逻辑：从剪贴板读取 JSON 并导入任务列表
    document.getElementById('importBtn').addEventListener('click', async () => {
      try {
        const text = await navigator.clipboard.readText();  // 读取剪贴板文本:contentReference[oaicite:24]{index=24}
        if (!text) {
          alert('剪贴板没有内容或内容为空！');
          return;
        }
        let importTasks;
        try {
          importTasks = JSON.parse(text);
        } catch (err) {
          alert('剪贴板内容不是有效的任务列表 JSON 格式！');
          return;
        }
        if (!Array.isArray(importTasks)) {
          alert('剪贴板JSON格式不正确：顶层应为数组！');
          return;
        }
        // 弹出确认提示，警告用户将覆盖现有任务
        const ok = confirm('导入操作将覆盖当前所有任务，确定继续吗？');
        if (!ok) return;
        // 清空当前任务并加载新任务列表
        tasks = importTasks;
        saveTasks();
        renderAllTasks();
        alert('任务列表已从剪贴板导入并替换当前任务！');
      } catch (err) {
        // 可能用户拒绝了读取剪贴板权限
        alert('无法读取剪贴板内容，请确保已复制了有效的任务 JSON 数据并授予粘贴权限。:contentReference[oaicite:25]{index=25}');
        console.error('读取剪贴板失败：', err);
      }
    });
  </script>
</body>
</html>
