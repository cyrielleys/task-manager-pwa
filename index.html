<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>任务管理PWA</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    /* 全局样式：统一字体大小，清除默认边距 */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      font-size: 11px;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    h1 {
      font-size: 11px;
      margin: 5px;
      text-align: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
      padding: 5px;
      background: #fff;
    }
    .controls input, .controls button {
      font-size: 11px;
    }
    #outer-container {
      flex: 1;
      position: relative;
      overflow: auto;
      background: #f0f0f0;
      cursor: grab;
    }
    #task-container {
      position: relative;
      width: 3000px;
      height: 2000px;
    }
    .task-card {
      position: absolute;
      min-width: 100px;
      max-width: 250px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px;
      box-sizing: border-box;
    }
    .task-card p {
      margin: 0;
      word-wrap: break-word;
    }
    .delete-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: #e74c3c;
      border: none;
      color: #fff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 12px;
      line-height: 16px;
      text-align: center;
      padding: 0;
      cursor: pointer;
    }
    .note-content {
      display: none;
      margin-top: 5px;
      font-style: italic;
      color: #555;
    }
    .note-toggle {
      display: block;
      margin-top: 5px;
      background: none;
      border: none;
      padding: 0;
      color: #06f;
      text-decoration: underline;
      cursor: pointer;
      font-size: 11px;
      text-align: right;
    }
  </style>
</head>
<body>
  <h1>任务管理PWA</h1>
  <div class="controls">
    <input id="content-input" type="text" placeholder="新任务内容" />
    <input id="note-input" type="text" placeholder="新备注内容 (可选)" />
    <button id="add-btn">添加任务</button>
    <button id="undo-btn">撤销删除</button>
    <button id="import-btn">导入</button>
    <button id="export-btn">导出</button>
  </div>
  <div id="outer-container">
    <div id="task-container"></div>
  </div>
  <script>
    // 从 localStorage 加载任务数据
    let tasks = [];
    try {
      const saved = localStorage.getItem('tasks');
      if (saved) tasks = JSON.parse(saved);
    } catch (e) {
      tasks = [];
    }
    // 如果是旧格式（字符串数组），升级为新格式（对象包含内容、备注、位置）
    if (tasks.length && typeof tasks[0] === 'string') {
      tasks = tasks.map((t, idx) => ({
        content: t,
        note: "",
        x: 20 + idx * 20,
        y: 80 + idx * 20
      }));
      localStorage.setItem('tasks', JSON.stringify(tasks));
    } else if (tasks.length && typeof tasks[0] === 'object') {
      tasks.forEach(task => {
        if (task.note === undefined) task.note = "";
        if (task.x === undefined) task.x = 20;
        if (task.y === undefined) task.y = 80;
      });
    }
    let lastRemovedTask = null;
    let lastRemovedIndex = null;
    // 拖拽状态变量
    let draggingTask = null;
    let dragIndex = null;
    let startPointerX = 0, startPointerY = 0;
    let startLeft = 0, startTop = 0;
    let isPanning = false;
    let panStartX = 0, panStartY = 0;
    let panStartScrollLeft = 0, panStartScrollTop = 0;
    // 渲染所有任务卡片
    function renderTasks() {
      const container = document.getElementById('task-container');
      container.innerHTML = "";
      tasks.forEach((task, index) => {
        // 创建任务卡片元素
        const taskEl = document.createElement('div');
        taskEl.className = 'task-card';
        taskEl.style.left = (task.x || 0) + 'px';
        taskEl.style.top = (task.y || 0) + 'px';
        // 任务内容文本
        const contentEl = document.createElement('p');
        contentEl.textContent = task.content;
        taskEl.appendChild(contentEl);
        // 如果有备注，创建备注元素和折叠/展开按钮
        if (task.note && task.note.trim() !== "") {
          const noteContentEl = document.createElement('p');
          noteContentEl.className = 'note-content';
          noteContentEl.textContent = task.note;
          taskEl.appendChild(noteContentEl);
          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'note-toggle';
          toggleBtn.textContent = '展开备注';
          toggleBtn.onclick = () => {
            if (noteContentEl.style.display === 'none') {
              noteContentEl.style.display = 'block';
              toggleBtn.textContent = '收起备注';
            } else {
              noteContentEl.style.display = 'none';
              toggleBtn.textContent = '展开备注';
            }
          };
          taskEl.appendChild(toggleBtn);
        }
        // 删除任务按钮
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = 'x';
        delBtn.onclick = () => {
          const removedTask = tasks.splice(index, 1)[0];
          localStorage.setItem('tasks', JSON.stringify(tasks));
          renderTasks();
          if (removedTask) {
            lastRemovedTask = removedTask;
            lastRemovedIndex = index;
          }
        };
        taskEl.appendChild(delBtn);
        // 为任务卡片绑定拖拽事件
        taskEl.addEventListener('pointerdown', e => {
          e.stopPropagation();
          if (e.target.classList.contains('delete-btn') || e.target.classList.contains('note-toggle')) {
            return; // 点击删除或备注按钮时不拖动卡片
          }
          // 开始拖动当前任务卡片
          draggingTask = taskEl;
          dragIndex = index;
          startPointerX = e.clientX;
          startPointerY = e.clientY;
          startLeft = taskEl.offsetLeft;
          startTop = taskEl.offsetTop;
          taskEl.setPointerCapture(e.pointerId);
          e.preventDefault();
        });
        taskEl.addEventListener('pointermove', e => {
          if (!draggingTask || draggingTask !== taskEl) return;
          const dx = e.clientX - startPointerX;
          const dy = e.clientY - startPointerY;
          let newLeft = startLeft + dx;
          let newTop = startTop + dy;
          if (newLeft < 0) newLeft = 0;
          if (newTop < 0) newTop = 0;
          const cont = document.getElementById('task-container');
          const maxLeft = cont.clientWidth - taskEl.offsetWidth;
          const maxTop = cont.clientHeight - taskEl.offsetHeight;
          if (newLeft > maxLeft) newLeft = maxLeft;
          if (newTop > maxTop) newTop = maxTop;
          taskEl.style.left = newLeft + 'px';
          taskEl.style.top = newTop + 'px';
        });
        taskEl.addEventListener('pointerup', e => {
          if (draggingTask && draggingTask === taskEl) {
            // 拖动结束，保存新位置
            tasks[dragIndex].x = taskEl.offsetLeft;
            tasks[dragIndex].y = taskEl.offsetTop;
            localStorage.setItem('tasks', JSON.stringify(tasks));
          }
          draggingTask = null;
          dragIndex = null;
          try { taskEl.releasePointerCapture(e.pointerId); } catch (err) {}
        });
        taskEl.addEventListener('pointercancel', e => {
          if (draggingTask && draggingTask === taskEl) {
            // 保存拖动时最新位置
            tasks[dragIndex].x = taskEl.offsetLeft;
            tasks[dragIndex].y = taskEl.offsetTop;
            localStorage.setItem('tasks', JSON.stringify(tasks));
          }
          draggingTask = null;
          dragIndex = null;
          try { taskEl.releasePointerCapture(e.pointerId); } catch (err) {}
        });
        container.appendChild(taskEl);
      });
    }
    // 初始化控件事件
    const contentInput = document.getElementById('content-input');
    const noteInput = document.getElementById('note-input');
    document.getElementById('add-btn').onclick = () => {
      const content = contentInput.value.trim();
      const note = noteInput.value.trim();
      if (content === "") {
        alert('请填写任务内容');
        return;
      }
      // 设置新任务初始位置，避免被按钮遮挡
      let newX = 20;
      let newY = 80;
      if (tasks.length > 0) {
        newX = 20 + (tasks.length * 10) % 100;
        newY = 80 + (tasks.length * 10) % 100;
      }
      const newTask = { content: content, note: note, x: newX, y: newY };
      tasks.push(newTask);
      contentInput.value = "";
      noteInput.value = "";
      localStorage.setItem('tasks', JSON.stringify(tasks));
      renderTasks();
    };
    document.getElementById('undo-btn').onclick = () => {
      if (lastRemovedTask) {
        // 将最后删除的任务恢复到原来的位置
        const idx = lastRemovedIndex;
        if (idx < 0 || idx > tasks.length) {
          tasks.push(lastRemovedTask);
        } else {
          tasks.splice(idx, 0, lastRemovedTask);
        }
        localStorage.setItem('tasks', JSON.stringify(tasks));
        lastRemovedTask = null;
        renderTasks();
      } else {
        alert('无可撤销的任务');
      }
    };
    document.getElementById('export-btn').onclick = () => {
      const dataStr = JSON.stringify(tasks);
      navigator.clipboard.writeText(dataStr).then(() => {
        alert('任务数据已复制到剪贴板');
      }).catch(err => {
        alert('导出失败: ' + err);
      });
    };
    document.getElementById('import-btn').onclick = () => {
      navigator.clipboard.readText().then(text => {
        if (!text) {
          alert('剪贴板没有内容');
          return;
        }
        let imported;
        try {
          imported = JSON.parse(text);
        } catch (err) {
          alert('剪贴板内容不是有效的JSON');
          return;
        }
        if (Array.isArray(imported)) {
          // 如果导入数据是旧格式或不完整，处理之
          if (imported.length && typeof imported[0] === 'string') {
            imported = imported.map((t, idx) => ({
              content: t,
              note: "",
              x: 20 + idx * 20,
              y: 80 + idx * 20
            }));
          } else if (imported.length && typeof imported[0] === 'object') {
            imported.forEach(task => {
              if (task.note === undefined) task.note = "";
              if (task.x === undefined) task.x = 20;
              if (task.y === undefined) task.y = 80;
            });
          }
          tasks = imported;
          localStorage.setItem('tasks', JSON.stringify(tasks));
          renderTasks();
          alert('任务数据已导入');
        } else {
          alert('剪贴板内容无效');
        }
      }).catch(err => {
        alert('无法读取剪贴板: ' + err);
      });
    };
    // 画布拖动（整体视图平移）
    const outer = document.getElementById('outer-container');
    outer.addEventListener('pointerdown', e => {
      isPanning = true;
      outer.setPointerCapture(e.pointerId);
      outer.style.cursor = 'grabbing';
      outer.style.userSelect = 'none';
      panStartX = e.clientX;
      panStartY = e.clientY;
      panStartScrollLeft = outer.scrollLeft;
      panStartScrollTop = outer.scrollTop;
    });
    outer.addEventListener('pointermove', e => {
      if (!isPanning) return;
      const dx = e.clientX - panStartX;
      const dy = e.clientY - panStartY;
      outer.scrollLeft = panStartScrollLeft - dx;
      outer.scrollTop = panStartScrollTop - dy;
      e.preventDefault();
    });
    outer.addEventListener('pointerup', e => {
      if (isPanning) {
        isPanning = false;
        outer.style.cursor = 'grab';
        outer.style.removeProperty('user-select');
      }
    });
    outer.addEventListener('pointerleave', e => {
      if (isPanning) {
        isPanning = false;
        outer.style.cursor = 'grab';
        outer.style.removeProperty('user-select');
      }
    });
    outer.addEventListener('pointercancel', e => {
      if (isPanning) {
        isPanning = false;
        outer.style.cursor = 'grab';
        outer.style.removeProperty('user-select');
      }
    });
    // 页面初始化时渲染任务卡片
    renderTasks();
    // 注册 Service Worker（PWA 支持）
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
