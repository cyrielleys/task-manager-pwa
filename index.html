<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Task Board PWA</title>
  <style>
    /* 全局字体统一为11px，包括按钮、输入框等 */
    html, body, button, input, textarea {
      font-size: 11px;
    }
    body { margin: 0; height: 100vh; overflow: hidden; }

    /* 画布外层容器，占据全屏，可滚动以呈现更大画布 */
    #board {
      width: 100%;
      height: 100%;
      overflow: auto;
      background: #f0f0f0; /* 灰色背景，区分画布区域 */
    }

    /* 画布区域本身，比视口大，可拖动画布平移视图 */
    #canvas {
      width: 2000px;
      height: 1500px;
      position: relative;
      background: #fff;
      touch-action: none; /* 禁用触摸默认滚动缩放行为 */
      /* 可选：改变鼠标光标提示可拖拽
         cursor: grab;
         cursor: grabing (active状态通过JS或:active设置) */
    }

    /* 任务卡片样式 */
    .task-card {
      position: absolute;
      width: 150px;
      background: #e3e3ff;
      border: 1px solid #888;
      border-radius: 4px;
      padding: 5px;
      box-sizing: border-box;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.15);
      touch-action: none; /* 禁用触摸时浏览器默认行为，以便自定义拖拽 */
    }
    .task-card header {
      font-weight: bold;
      margin-bottom: 3px;
    }
    /* 折叠/展开备注的按钮 */
    .toggle-note {
      position: absolute;
      top: 2px;
      left: 2px;
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 11px;
    }
    /* 备注区域，默认隐藏 */
    .note {
      display: none;
      background: #f9f9ff;
      border-top: 1px solid #ccc;
      margin-top: 4px;
      padding: 3px;
    }
    /* 展开备注时的样式（通过添加此类显示备注） */
    .note.show {
      display: block;
    }
  </style>
</head>
<body>
  <!-- 示例：任务添加输入框和按钮，验证字体统一 -->
  <div style="margin:5px;">
    <input type="text" id="newTaskTitle" placeholder="Task title" />
    <button id="addTask">Add Task</button>
  </div>
  <!-- 画布视口容器 -->
  <div id="board">
    <!-- 实际画布区域 -->
    <div id="canvas">
      <!-- 示例任务卡片1 -->
      <div class="task-card" style="left:50px; top:50px;">
        <button class="toggle-note">▶</button>
        <header>Task 1</header>
        <div class="note">This is a note or description for task 1.</div>
      </div>
      <!-- 示例任务卡片2 -->
      <div class="task-card" style="left:300px; top:120px;">
        <button class="toggle-note">▶</button>
        <header>Task 2</header>
        <div class="note">Another task's detailed notes.</div>
      </div>
      <!-- 示例任务卡片3 -->
      <div class="task-card" style="left:500px; top:300px;">
        <button class="toggle-note">▶</button>
        <header>Task 3</header>
        <div class="note">Some other info for task 3.</div>
      </div>
    </div>
  </div>

  <script>
    // 为所有任务卡片绑定拖拽事件
    document.querySelectorAll('.task-card').forEach(card => {
      card.addEventListener('pointerdown', function(e) {
        if (e.button !== 0) return;  // 仅响应左键或触摸
        e.preventDefault();          // 阻止默认行为（如文本选择）
        // 捕获指针，使后续移动事件始终由当前卡片接收
        card.setPointerCapture(e.pointerId);
        // 在pointermove中更新卡片位置
        card.addEventListener('pointermove', onPointerMove);
        // 监听pointerup和pointercancel，指针释放时停止拖拽
        card.addEventListener('pointerup', onPointerUp);
        card.addEventListener('pointercancel', onPointerUp);

        function onPointerMove(e) {
          // 根据pointer移动增量更新卡片位置
          card.style.left = (card.offsetLeft + e.movementX) + 'px';
          card.style.top  = (card.offsetTop  + e.movementY) + 'px';
        }
        function onPointerUp(e) {
          // 移除事件监听并释放指针捕获
          card.removeEventListener('pointermove', onPointerMove);
          card.removeEventListener('pointerup', onPointerUp);
          card.removeEventListener('pointercancel', onPointerUp);
          card.releasePointerCapture(e.pointerId);
        }
      });
    });

    // 画布背景拖拽平移视图
    const board = document.getElementById('board');
    const canvas = document.getElementById('canvas');
    canvas.addEventListener('pointerdown', function(e) {
      // 仅当点击目标是canvas本身（而非卡片）时才触发平移
      if (e.target !== canvas) return;
      e.preventDefault();
      canvas.setPointerCapture(e.pointerId);
      canvas.addEventListener('pointermove', onPointerMove);
      canvas.addEventListener('pointerup', onPointerUp);
      canvas.addEventListener('pointercancel', onPointerUp);

      function onPointerMove(e) {
        // 拖动时调整容器滚动位置，产生画布平移效果
        board.scrollLeft -= e.movementX;
        board.scrollTop  -= e.movementY;
      }
      function onPointerUp(e) {
        canvas.removeEventListener('pointermove', onPointerMove);
        canvas.removeEventListener('pointerup', onPointerUp);
        canvas.removeEventListener('pointercancel', onPointerUp);
        canvas.releasePointerCapture(e.pointerId);
      }
    });

    // 切换备注显示/隐藏
    document.querySelectorAll('.toggle-note').forEach(btn => {
      btn.addEventListener('click', function() {
        const card = btn.closest('.task-card');
        const note = card.querySelector('.note');
        if (!note) return;
        if (note.classList.contains('show')) {
          // 当前已展开，点击后收起
          note.classList.remove('show');
          btn.textContent = '';  // 按钮显示折叠状态图标
        } else {
          // 当前是折叠的，点击后展开
          note.classList.add('show');
          btn.textContent = '';  // 按钮显示展开状态图标
        }
      });
    });

    // 示例：添加新任务卡片（用于演示输入框和按钮字体及动态绑定事件）
    document.getElementById('addTask').addEventListener('click', function() {
      const titleInput = document.getElementById('newTaskTitle');
      const title = titleInput.value.trim();
      if (!title) return;
      // 创建新的任务卡片元素
      const newCard = document.createElement('div');
      newCard.className = 'task-card';
      newCard.style.left = '100px';
      newCard.style.top = '100px';
      // 设置卡片内部结构，包含toggle按钮、标题和备注
      newCard.innerHTML = '<button class="toggle-note">▶</button>'
                        + '<header></header>'
                        + '<div class="note"></div>';
      newCard.querySelector('header').textContent = title;
      newCard.querySelector('.note').textContent = 'New task note...';
      canvas.appendChild(newCard);
      // 绑定拖拽事件（与上面逻辑相同）
      newCard.addEventListener('pointerdown', function(e) {
        if (e.button !== 0) return;
        e.preventDefault();
        newCard.setPointerCapture(e.pointerId);
        newCard.addEventListener('pointermove', onPointerMove);
        newCard.addEventListener('pointerup', onPointerUp);
        newCard.addEventListener('pointercancel', onPointerUp);
        function onPointerMove(e) {
          newCard.style.left = (newCard.offsetLeft + e.movementX) + 'px';
          newCard.style.top  = (newCard.offsetTop  + e.movementY) + 'px';
        }
        function onPointerUp(e) {
          newCard.removeEventListener('pointermove', onPointerMove);
          newCard.removeEventListener('pointerup', onPointerUp);
          newCard.removeEventListener('pointercancel', onPointerUp);
          newCard.releasePointerCapture(e.pointerId);
        }
      });
      // 绑定备注展开/折叠切换事件
      newCard.querySelector('.toggle-note').addEventListener('click', function() {
        const note = newCard.querySelector('.note');
        if (!note) return;
        if (note.classList.contains('show')) {
          note.classList.remove('show');
          this.textContent = '';
        } else {
          note.classList.add('show');
          this.textContent = '';
        }
      });
      titleInput.value = ''; // 清空输入框
    });
  </script>
</body>
</html>
