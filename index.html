<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>任务管理PWA</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body, html {
      margin: 0; padding: 0; overflow: hidden; font-family: sans-serif;
    }
    #canvas {
      width: 300vw; height: 200vh;
      position: relative; background-color: #f0f0f0;
      touch-action: none;
      overflow: hidden;
    }
    .task {
      position: absolute; padding: 8px; border: 1px solid #ccc;
      border-radius: 8px; background-color: #fff; font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      touch-action: none; user-select: none;
      white-space: pre-wrap; word-break: break-word;
      max-width: 160px;
      display: inline-block;
    }
    .delete-btn {
      position: absolute; top: -8px; right: -8px;
      background-color: red; color: white; border: none;
      width: 16px; height: 16px; border-radius: 50%;
      cursor: pointer; font-size: 12px;
    }
    .expand-btn {
      position: absolute; top: -8px; left: -8px;
      background-color: #007bff; color: white; border: none;
      width: 16px; height: 16px; border-radius: 50%;
      cursor: pointer; font-size: 12px;
    }
    .details {
      display: none; margin-top: 4px; font-size: 12px; color: #666;
    }
    #undo-btn {
      position: fixed; top: 10px; right: 10px;
      display: none; padding: 5px 10px; font-size: 14px;
      z-index: 100; background-color: #007bff;
      color: white; border: none; border-radius: 4px;
    }
    #controls {
      position: fixed; top: 10px; left: 10px; z-index: 100;
      display: flex; flex-direction: column;
    }
    input, button { margin: 2px; padding: 5px; font-size: 14px; }
  </style>
</head>
<body>

<button id="undo-btn">撤销删除</button>
<div id="controls">
  <input type="text" id="task-input" placeholder="新任务内容">
  <input type="text" id="details-input" placeholder="新备注内容（可选）">
  <button id="add-btn">添加任务</button>
</div>
<div id="canvas"></div>

<script>
  let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
  let deletedTask = null;
  const canvas = document.getElementById('canvas');
  const undoBtn = document.getElementById('undo-btn');

  function saveTasks() {
    localStorage.setItem('tasks', JSON.stringify(tasks));
  }

  function renderTasks() {
    canvas.innerHTML = '';
    tasks.forEach((task, idx) => {
      const el = document.createElement('div');
      el.className = 'task';
      el.style.left = task.x + 'px';
      el.style.top = task.y + 'px';

      const title = document.createElement('div');
      title.textContent = task.text;
      el.appendChild(title);

      if (task.details) {
        const expandBtn = document.createElement('button');
        expandBtn.className = 'expand-btn';
        expandBtn.textContent = '+';
        el.appendChild(expandBtn);

        const details = document.createElement('div');
        details.className = 'details';
        details.textContent = task.details;
        el.appendChild(details);

        expandBtn.onclick = (e) => {
          e.stopPropagation();
          details.style.display = details.style.display === 'none' ? 'block' : 'none';
        };
      }

      const delBtn = document.createElement('button');
      delBtn.className = 'delete-btn'; delBtn.textContent = '×';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        deletedTask = {...task, idx};
        tasks.splice(idx, 1);
        saveTasks(); renderTasks();
        undoBtn.style.display = 'block';
      };
      el.appendChild(delBtn);

      let offsetX, offsetY, dragging;
      el.onpointerdown = e => {
        dragging = el; el.setPointerCapture(e.pointerId);
        offsetX = e.clientX - el.offsetLeft;
        offsetY = e.clientY - el.offsetTop;
      };
      el.onpointermove = e => {
        if (dragging !== el) return;
        el.style.left = (e.clientX - offsetX) + 'px';
        el.style.top = (e.clientY - offsetY) + 'px';
      };
      el.onpointerup = el.onpointercancel = () => {
        if (dragging === el) {
          dragging = null;
          task.x = el.offsetLeft; task.y = el.offsetTop;
          saveTasks();
        }
      };
      canvas.appendChild(el);
    });
  }

  undoBtn.onclick = () => {
    if (deletedTask) {
      tasks.splice(deletedTask.idx, 0, deletedTask);
      saveTasks(); renderTasks();
      undoBtn.style.display = 'none';
      deletedTask = null;
    }
  };

  document.getElementById('add-btn').onclick = () => {
    const titleInput = document.getElementById('task-input');
    const detailsInput = document.getElementById('details-input');
    if (titleInput.value.trim()) {
      tasks.push({ text: titleInput.value.trim(), details: detailsInput.value.trim(), x: 20, y: 20 });
      titleInput.value = ''; detailsInput.value = ''; saveTasks(); renderTasks();
    }
  };

  renderTasks();

  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
